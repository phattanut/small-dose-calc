<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Small Dose Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
      body { 
        background-color: #f0f2f5; 
        padding: 10px; 
        font-family: 'Sarabun', sans-serif; 
      }
      .main-card { 
        border-radius: 20px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        border: none;
        overflow: hidden;
      }
      .card-header-custom {
        background-color: #1DB446;
        color: white;
        padding: 20px;
        text-align: center;
      }
      .btn-calculate { 
        background-color: #1DB446; 
        color: white; 
        width: 100%; 
        font-weight: bold; 
        border-radius: 10px;
        padding: 12px;
      }
      .btn-calculate:hover { background-color: #169e3b; color: white; }
      
      /* Result Styles */
      #resultArea { display: none; margin-top: 20px; }
      .result-box { 
        background: white; 
        border-radius: 15px; 
        padding: 20px; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }
      .section-title { font-size: 0.9rem; color: #888; font-weight: bold; margin-bottom: 10px; margin-top: 15px; }
      .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
      .data-label { color: #666; }
      .data-value { font-weight: 500; color: #000; text-align: right; }
      .big-result { font-size: 2.5rem; font-weight: bold; text-align: center; color: #000; line-height: 1.2; }
      .sub-result { font-size: 0.85rem; color: #999; text-align: center; margin-bottom: 15px; }
      .note-box { 
        background-color: #fff5e6; 
        border-radius: 8px; 
        padding: 10px; 
        font-size: 0.85rem; 
        color: #cc7a00; 
        margin-top: 10px;
        white-space: pre-wrap;
      }
      .stability-box {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin-top: 10px;
      }
      /* Button Styles inside Flex Message */
      .flex-btn {
        width: 100%;
        margin-top: 8px;
        border-radius: 8px;
        padding: 10px;
        font-size: 0.9rem;
        font-weight: bold;
        border: none;
      }
      .flex-btn-primary { background-color: #1DB446; color: white; }
      .flex-btn-secondary { background-color: #FF3333; color: white; }
      .flex-btn:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <div class="container" style="max-width: 500px; padding: 0;">
      
      <div class="card main-card mb-3">
        <div class="card-header-custom">
          <h4 class="m-0">üë©‚Äç‚öïÔ∏è Small Dose Calc</h4>
        </div>
        <div class="card-body p-4">
          <form id="calcForm">
            <div class="mb-3">
              <label for="drugSelect" class="form-label fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤</label>
              <select class="form-select form-select-lg" id="drugSelect" required>
                <option value="" selected disabled>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
              </select>
            </div>
            
            <div class="mb-4">
              <label for="doseInput" class="form-label fw-bold">‡∏Ç‡∏ô‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (Dose)</label>
              <input type="number" step="any" class="form-control form-control-lg" id="doseInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (mg/Unit)" required>
            </div>
            
            <button type="submit" class="btn btn-calculate">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
          </form>
          
          <div id="loading" class="text-center mt-3" style="display:none;">
            <div class="spinner-border text-success" role="status"></div>
            <p class="text-muted small mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</p>
          </div>
        </div>
      </div>

      <div id="resultArea">
        <div class="result-box" id="resultContent"></div>
        <div class="text-center mt-3 mb-5">
           <small class="text-muted">‚ö†Ô∏è ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥</small>
        </div>
      </div>

    </div>

    <script>
      // ==========================================
      // ‚ö†Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      // ==========================================
      const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzqTPpgKuhL7_ZvohluwJOtguBRcwjQ8NoDbYR3iT2qaLv8huvhAp9VJ5m4LU2uEaiQnQ/exec"; 
      // ==========================================

      let currentDrug = "";
      let currentDose = 0;

      // 1. Initialize (‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ú‡πà‡∏≤‡∏ô API)
      window.onload = function() {
        fetch(WEB_APP_URL + "?action=getDrugs")
          .then(response => response.json())
          .then(drugs => {
             const select = document.getElementById('drugSelect');
             select.innerHTML = '<option value="" selected disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏≤ --</option>';
             drugs.forEach(drug => {
               let option = document.createElement("option");
               option.text = drug;
               option.value = drug;
               select.add(option);
             });
          })
          .catch(err => {
             console.error(err);
             document.getElementById('drugSelect').innerHTML = '<option disabled>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>';
          });
      };

      // 2. Handle Submit (‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)
      document.getElementById('calcForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        currentDrug = document.getElementById('drugSelect').value;
        currentDose = parseFloat(document.getElementById('doseInput').value);

        if(!currentDrug || !currentDose) return;
        
        callApi(currentDrug, currentDose, 'check');
      });

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏¥‡∏á API ‡πÑ‡∏õ‡∏´‡∏≤ Google Sheets
      function callApi(drug, dose, mode) {
        showLoading();
        
        // ‡∏à‡∏≥‡∏•‡∏≠‡∏á JSON ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà LINE ‡∏™‡πà‡∏á‡∏°‡∏≤ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Code.gs ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        const payload = {
            events: [{
                type: 'postback',
                postback: { data: `action=calc&drug=${encodeURIComponent(drug)}&dose=${dose}&mode=${mode}` },
                source: { userId: 'web_guest' },
                replyToken: 'dummy'
            }]
        };

        fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { "Content-Type": "text/plain;charset=utf-8" } // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS
        })
        .then(res => res.json())
        .then(response => {
             renderFlexMessage(response);
        })
        .catch(err => {
             alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: " + err);
             document.getElementById('loading').style.display = 'none';
        });
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° (‡πÉ‡∏ä‡πâ fetch ‡πÅ‡∏ó‡∏ô)
      function reCalculate(mode) {
         callApi(currentDrug, currentDose, mode);
      }

      function showLoading() {
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('loading').style.display = 'block';
      }

      // 3. Parser: ‡πÅ‡∏õ‡∏•‡∏á Flex Message ‡πÄ‡∏õ‡πá‡∏ô HTML (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö API Response)
      function renderFlexMessage(response) {
        document.getElementById('loading').style.display = 'none';
        const resultArea = document.getElementById('resultArea');
        const contentDiv = document.getElementById('resultContent');
        contentDiv.innerHTML = ''; 

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
        if (typeof response === 'string') {
             contentDiv.innerHTML = `<div class="alert alert-danger">${response}</div>`;
             resultArea.style.display = 'block';
             return;
        }
        
        // ‡∏Å‡∏£‡∏ì‡∏µ GAS ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô array (‡πÄ‡∏ä‡πà‡∏ô replyToLine ‡πÄ‡∏î‡∏¥‡∏°‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô array)
        let flexContent = response;
        if (Array.isArray(response) && response.length > 0) {
            flexContent = response[0];
        }

        if (!flexContent.contents) {
             contentDiv.innerHTML = `<div class="alert alert-danger">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>`;
             resultArea.style.display = 'block';
             return;
        }

        try {
            const contents = flexContent.contents; // Bubble Container
            
            // --- Header ---
            const header = contents.header;
            if (header && header.backgroundColor === '#ffcc00') { // Warning Style
               const title = header.contents[0].text;
               const subtitle = header.contents[1].text;
               contentDiv.innerHTML += `
                 <div class="alert alert-warning text-center">
                   <h5 class="fw-bold text-dark">${title}</h5>
                   <p class="mb-0 text-dark small">${subtitle}</p>
                 </div>
               `;
            } else if (header && header.backgroundColor === '#1DB446') { // Success/Normal Style
               // ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÉ‡∏™‡πà Header ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            }

            // --- Body ---
            const bodyContents = contents.body.contents;
            bodyContents.forEach(item => {
                if (item.type === 'text' && item.color === '#888888') {
                    contentDiv.innerHTML += `<div class="section-title">${item.text}</div>`;
                } else if (item.type === 'separator') {
                    contentDiv.innerHTML += `<hr style="margin: 10px 0; border-top: 1px dashed #ddd;">`;
                } else if (item.type === 'box' && item.contents && item.contents[0].size === 'xxl') {
                    contentDiv.innerHTML += `<div class="big-result">${item.contents[0].text}</div><div class="sub-result">${item.contents[1].text}</div>`;
                } else if (item.type === 'box' && item.layout === 'baseline') {
                    contentDiv.innerHTML += `<div class="data-row"><span class="data-label">${item.contents[0].text}</span><span class="data-value" style="color:${item.contents[1].color||'#000'}; font-weight:${item.contents[1].weight==='bold'?'bold':'normal'}">${item.contents[1].text}</span></div>`;
                } else if (item.type === 'box' && item.backgroundColor === '#fff5e6') {
                    contentDiv.innerHTML += `<div class="note-box">${item.contents[0].text}</div>`;
                } else if (item.type === 'box' && item.backgroundColor === '#f8f9fa') {
                    let html = `<div class="stability-box">`;
                    item.contents.forEach(sub => {
                        if(sub.type === 'text') html += `<div style="font-size:0.8rem; font-weight:bold; color:#555;">${sub.text}</div>`;
                        else if (sub.type === 'box') html += `<div style="display:flex; justify-content:space-between; font-size:0.85rem; color:#666;"><span>${sub.contents[0].text}</span><span>${sub.contents[1].text}</span></div>`;
                        else if (sub.type === 'separator') html += `<hr style="margin:5px 0;">`;
                    });
                    html += `</div>`;
                    contentDiv.innerHTML += html;
                } else if (item.type === 'text' && item.color === '#FF3333') {
                     contentDiv.innerHTML += `<div style="color:#FF3333; font-weight:bold; text-align:center;">${item.text}</div>`;
                } else if (item.type === 'text') { 
                     contentDiv.innerHTML += `<div style="text-align:center; margin-top:10px; font-weight:${item.weight}; font-size:${item.size==='lg'?'1.1rem':'0.9rem'}">${item.text}</div>`;
                }
            });

            // --- Footer (Buttons) ---
            const footer = contents.footer;
            if (footer) {
               let btnHtml = `<div class="mt-3">`;
               footer.contents.forEach(btn => {
                  const dataStr = btn.action.data;
                  let mode = 'check';
                  if (dataStr.includes('mode=force_dilute')) mode = 'force_dilute';
                  else if (dataStr.includes('mode=force_direct')) mode = 'force_direct';
                  
                  const btnClass = btn.style === 'primary' ? 'flex-btn-primary' : 'flex-btn-secondary';
                  btnHtml += `<button class="flex-btn ${btnClass}" onclick="reCalculate('${mode}')">${btn.action.label}</button>`;
               });
               btnHtml += `</div>`;
               contentDiv.innerHTML += btnHtml;
            }

            resultArea.style.display = 'block';

        } catch (e) {
            console.error(e);
            contentDiv.innerHTML = `<div class="alert alert-danger">Display Error: ${e.message}</div>`;
            resultArea.style.display = 'block';
        }
      }
    </script>
</body>
</html>